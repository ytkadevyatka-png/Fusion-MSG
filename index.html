<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fusion Chat</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
</head>
<body>

    <div id="toast-container"></div>

    <audio id="soundRingtone" loop src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
    <audio id="soundConnecting" loop src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3"></audio>

    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Fusion</h2>
                <button id="settingsBtn" class="icon-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"><span class="material-symbols-outlined">settings</span></button>
            </div>

            <div class="sidebar-menu">
                <button id="friendsBtn" class="menu-btn relative-btn">
                    <span class="material-symbols-outlined">group</span>
                    <span>–õ—é–¥–∏ –∏ –∑–∞—è–≤–∫–∏</span>
                    <div id="sidebarRequestsBadge" class="notification-badge" style="display: none;"></div>
                </button>
                <button id="createGroupBtn" class="menu-btn">
                    <span class="material-symbols-outlined">add_circle</span>
                    <span>–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</span>
                </button>
            </div>
            
            <div id="chatsList" class="chats-list">
                <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>

            <div class="sidebar-bottom-wrapper">
                <div id="activityStatusBar" class="activity-status-bar">
                    <span class="material-symbols-outlined icon-tiny">radio_button_checked</span>
                    <span id="activityStatusText">–í –º–µ–Ω—é</span>
                </div>
                
                <div id="sidebarUserProfile" class="user-mini-profile clickable-profile">
                    <img id="miniProfileAvatar" src="" alt="A">
                    <div class="mini-profile-info">
                        <div id="miniProfileName" class="mini-name">...</div>
                        <div id="miniProfileStatus" class="mini-status">...</div>
                    </div>
                    <button id="globalMuteBtn" class="icon-btn tiny-btn" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω"><span class="material-symbols-outlined" id="globalMuteIcon">mic</span></button>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div id="emptyState" class="empty-state">
                <div class="empty-content">
                    <h3>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç ‚ú®</h3>
                    <p>–ù–∞—Ö–æ–¥–∏—Ç–µ –¥—Ä—É–∑–µ–π –≤ –º–µ–Ω—é —Å–ª–µ–≤–∞</p>
                </div>
            </div>

            <div id="chatRoom" class="chat-room" style="display: none;">
                <header class="chat-header">
                    <button id="backToChatsBtn" class="icon-btn" style="display: none; margin-right: 10px;">
                        <span class="material-symbols-outlined">arrow_back</span>
                    </button>

                    <div class="header-user-info" id="chatHeaderInfoArea" style="cursor: pointer;"> 
                        <div id="chatHeaderAvatar" class="header-avatar"></div> 
                        <div>
                            <span id="chatTitle" class="chat-title-name">–ò–º—è</span>
                            <div id="chatHeaderStatus" class="header-status-text"></div>
                        </div>
                    </div>
                    <button id="startCallBtn" class="icon-btn" title="–ü–æ–∑–≤–æ–Ω–∏—Ç—å">
                        <span class="material-symbols-outlined">call</span>
                    </button>
                </header>

                <div id="callInterface" class="call-embedded" style="display: none;">
                    <div class="call-content-wrapper">
                        <div class="call-avatars-row">
                            <div class="avatar-wrapper-call local" id="localAvatarWrapper">
                                <img id="localCallAvatar" src="" alt="–Ø">
                                <div class="mic-badge"><span class="material-symbols-outlined">mic_off</span></div>
                                <span class="avatar-label">–í—ã</span>
                            </div>
                            <div class="avatar-wrapper-call remote" id="remoteAvatarWrapper">
                                <div class="pulse-ring"></div>
                                <div class="pulse-ring delay"></div>
                                <img id="remoteCallAvatar" src="" alt="–°–æ–±–µ—Å–µ–¥–Ω–∏–∫">
                                <div class="mic-badge"><span class="material-symbols-outlined">mic_off</span></div>
                                <span id="remoteAvatarLabel" class="avatar-label">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</span>
                            </div>
                        </div>
                        <div id="callStatusText" class="call-status-text">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</div>
                        <div id="callTimer" class="call-timer" style="display: none;">00:00</div>
                        <audio id="remoteAudio" autoplay></audio>
                        <div class="call-controls">
                            <button id="muteBtn" class="call-btn btn-mute"><span class="material-symbols-outlined" id="muteIcon">mic</span></button>
                            <button id="hangupBtn" class="call-btn btn-hangup"><span class="material-symbols-outlined">call_end</span></button>
                        </div>
                    </div>
                    <div id="resizeHandle" class="resize-handle"><div class="handle-bar"></div></div>
                </div>
                
                <div id="messagesList" class="messages-list"></div>
                
                <div class="input-area">
                    <div class="input-wrapper">
                        <input type="text" id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
                        <button id="sendBtn" class="send-btn"><span class="material-symbols-outlined">send</span></button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="initialSetupModal" class="modal" style="z-index: 20000;">
        <div class="glass-panel profile-card-container">
            <h2 class="modal-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
            <p style="margin-bottom: 20px; color: var(--text-sub); font-size: 14px;">–î–∞–≤–∞–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏–º –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –æ–±—â–µ–Ω–∏—è.</p>
            <div class="avatar-upload-preview"><img id="setupAvatarPreview" src="https://cdn-icons-png.flaticon.com/512/847/847969.png"></div>
            <input type="text" id="setupAvatarUrl" class="settings-input" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä (URL)">
            <input type="text" id="setupDisplayName" class="settings-input" placeholder="–í–∞—à–µ –∏–º—è">
            <input type="text" id="setupUsername" class="settings-input" placeholder="@username">
            <button id="finishSetupBtn" class="primary-btn" style="width: 100%;">–ù–∞—á–∞—Ç—å</button>
        </div>
    </div>

    <div id="editProfileModal" class="modal">
        <div class="glass-panel profile-card-container">
            <span id="closeEditProfile" class="close-btn">&times;</span>
            <h3 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <div class="avatar-upload-preview"><img id="editAvatarPreview" src=""></div>
            <label style="font-size: 12px; color: var(--text-sub); align-self: flex-start; margin-bottom: 5px;">–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä</label>
            <input type="text" id="editAvatarUrl" class="settings-input">
            <label style="font-size: 12px; color: var(--text-sub); align-self: flex-start; margin-bottom: 5px;">–ò–º—è</label>
            <input type="text" id="editDisplayName" class="settings-input">
            <label style="font-size: 12px; color: var(--text-sub); align-self: flex-start; margin-bottom: 5px;">Username</label>
            <input type="text" id="editUsername" class="settings-input">
            <button id="saveProfileChangesBtn" class="primary-btn" style="width: 100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <div id="currentUserProfileModal" class="modal">
        <div class="glass-panel profile-card-container">
            <span id="closeUserProfile" class="close-btn">&times;</span>
            <div class="profile-card-header"><img id="fullProfileAvatar" src="" alt="Avatar"></div>
            <div class="profile-card-body">
                <h2 id="fullProfileName">Name</h2>
                <p id="fullProfileUsername" style="color:var(--primary-color); margin-bottom:5px; font-weight:bold;">@username</p>
                <p id="fullProfileEmail" class="profile-email">email</p>
                <div class="profile-stat-badge"><span id="fullProfileStatusIndicator" class="status-indicator"></span><span id="fullProfileStatusText">...</span></div>
                <div class="profile-id-box">ID: <span id="fullProfileId" class="code-text">...</span></div>
            </div>
        </div>
    </div>

    <div id="friendsModal" class="modal">
        <div class="glass-panel split-modal-layout">
            <span id="closeFriends" class="close-btn">&times;</span>
            <div class="split-sidebar">
                <div class="modal-nav-item active" data-target="ftab-my-friends"><span class="material-symbols-outlined">person</span> –î—Ä—É–∑—å—è</div>
                <div class="modal-nav-item" data-target="ftab-search"><span class="material-symbols-outlined">search</span> –ü–æ–∏—Å–∫</div>
                <div class="modal-nav-item" data-target="ftab-requests"><span class="material-symbols-outlined">notifications</span> –ó–∞—è–≤–∫–∏ <div id="modalRequestsBadge" class="notification-badge-small" style="display:none;">0</div></div>
            </div>
            <div class="split-content">
                <div id="ftab-my-friends" class="tab-pane active"><h3 class="modal-title">–î—Ä—É–∑—å—è</h3><div id="myFriendsList" class="friends-grid"></div></div>
                <div id="ftab-search" class="tab-pane"><h3 class="modal-title">–ü–æ–∏—Å–∫</h3><div class="search-box"><input type="text" id="userSearchInput" class="settings-input" placeholder="–ò–º—è –∏–ª–∏ @..."><button id="userSearchBtn" class="primary-btn" style="width: auto;">–ù–∞–π—Ç–∏</button></div><div id="searchResultsList" class="friends-grid"></div></div>
                <div id="ftab-requests" class="tab-pane"><h3 class="modal-title">–ó–∞—è–≤–∫–∏</h3><div id="friendRequestsList" class="requests-list"></div></div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="glass-panel split-modal-layout">
            <span id="closeSettings" class="close-btn">&times;</span>
            <div class="split-sidebar">
                <div class="modal-nav-item active" data-target="tab-profile"><span class="material-symbols-outlined">person</span> –ü—Ä–æ—Ñ–∏–ª—å</div>
                <div class="modal-nav-item" data-target="tab-status"><span class="material-symbols-outlined">toggle_on</span> –°—Ç–∞—Ç—É—Å</div>
                <div class="modal-nav-item" data-target="tab-appearance"><span class="material-symbols-outlined">palette</span> –í–∏–¥</div>
                <div class="modal-nav-item" data-target="tab-account"><span class="material-symbols-outlined">logout</span> –ê–∫–∫–∞—É–Ω—Ç</div>
            </div>
            <div class="split-content">
                <div id="tab-profile" class="tab-pane active"><h3 class="modal-title">–ü—Ä–æ—Ñ–∏–ª—å</h3><div id="settingsProfileInfo" class="profile-large"></div><button id="openEditProfileBtn" class="primary-btn" style="width: 100%; margin-top: 10px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button></div>
                <div id="tab-status" class="tab-pane"><h3 class="modal-title">–°—Ç–∞—Ç—É—Å</h3><select id="statusSelect" class="settings-input"><option value="online">üü¢ –í —Å–µ—Ç–∏</option><option value="busy">üî¥ –ù–µ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å</option><option value="offline">‚ö™ –ù–µ–≤–∏–¥–∏–º–∫–∞</option></select><input type="text" id="customStatusInput" class="settings-input" placeholder="–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞..." maxlength="30"><button id="saveSettingsBtn" class="primary-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
                <div id="tab-appearance" class="tab-pane"><h3 class="modal-title">–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h3><select id="bgAnimSelect" class="settings-input" style="margin-bottom: 20px;"><option value="bg-static">–°—Ç–∞—Ç–∏—á–Ω—ã–π</option><optgroup label="–≠—Ñ—Ñ–µ–∫—Ç—ã"><option value="bg-flow">–ü–æ—Ç–æ–∫</option><option value="bg-ocean">–û–∫–µ–∞–Ω</option><option value="bg-pulse">–ü—É–ª—å—Å–∞—Ü–∏—è</option></optgroup></select><div class="theme-group-title">–¢–µ–º—ã</div><div class="themes-grid"><div class="theme-card" data-theme="pure-white"><div class="theme-preview" style="background:#fff;"></div><span>White</span></div><div class="theme-card" data-theme="pitch-black"><div class="theme-preview" style="background:#000;"></div><span>Black</span></div><div class="theme-card active" data-theme="default"><div class="theme-preview" style="background:linear-gradient(135deg,#ee7752,#23d5ab);"></div><span>Aurora</span></div><div class="theme-card" data-theme="standard-dark"><div class="theme-preview" style="background:#202225;"></div><span>Dark</span></div><div class="theme-card" data-theme="midnight"><div class="theme-preview" style="background:linear-gradient(-45deg,#0f2027,#2c5364);"></div><span>Night</span></div></div></div>
                <div id="tab-account" class="tab-pane"><h3 class="modal-title">–ê–∫–∫–∞—É–Ω—Ç</h3><button id="logoutBtn" class="secondary-btn" style="width:100%; margin-bottom: 20px;">–í—ã–π—Ç–∏</button><div style="border-top: 1px solid rgba(255,0,0,0.2); padding-top: 15px;"><button id="deleteAccountBtn" class="danger-btn">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button></div></div>
            </div>
        </div>
    </div>

    <div id="createGroupModal" class="modal"><div class="glass-panel group-creation-container"><div class="group-modal-header"><h2>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h2><span id="closeCreateGroup" class="close-icon-btn"><span class="material-symbols-outlined">close</span></span></div><div class="group-input-area"><div class="group-avatar-placeholder"><span class="material-symbols-outlined">groups</span></div><input type="text" id="newGroupName" class="group-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ..." autocomplete="off"></div><div class="group-members-label">–£—á–∞—Å—Ç–Ω–∏–∫–∏</div><div id="usersForGroupList" class="users-grid-selector"></div><div class="group-modal-footer"><button id="confirmCreateGroupBtn" class="primary-btn create-btn"><span class="material-symbols-outlined">check</span> –°–æ–∑–¥–∞—Ç—å</button></div></div></div>
    <div id="customConfirmModal" class="modal"><div class="glass-panel" style="width: 320px; text-align: center; padding: 30px;"><div style="margin-bottom: 15px; color: var(--primary-color);"><span class="material-symbols-outlined" style="font-size: 40px;">help</span></div><h3 style="margin-bottom: 10px;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3><p id="confirmMessage" style="color: var(--text-sub); margin-bottom: 25px; font-size: 14px; line-height: 1.4;">...</p><div class="confirm-actions"><button id="confirmCancelBtn" class="secondary-btn">–û—Ç–º–µ–Ω–∞</button><button id="confirmOkBtn" class="primary-btn">–î–∞</button></div></div></div>
    <div id="groupInfoModal" class="modal"><div class="glass-panel" style="width: 350px; text-align: center; padding: 20px;"><span id="closeGroupInfo" class="close-btn">&times;</span><div class="group-avatar-placeholder" style="margin: 0 auto 15px; width: 80px; height: 80px;"><span class="material-symbols-outlined" style="font-size: 40px;">groups</span></div><h2 id="infoGroupName" style="margin-bottom: 5px;">...</h2><p id="infoGroupCount" style="color: var(--text-sub); font-size: 14px; margin-bottom: 25px;">...</p><div id="groupCreatorActions" style="display: none;"><p style="font-size: 12px; color: #ff4444; margin-bottom: 10px;">–í—ã —Å–æ–∑–¥–∞—Ç–µ–ª—å</p><button id="deleteGroupBtn" class="danger-btn">–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É</button></div><div id="groupMemberActions" style="display: none;"><div style="margin-bottom: 15px; text-align: left; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 8px;"><label style="display: flex; align-items: center; gap: 10px; cursor: pointer;"><input type="checkbox" id="notifyLeaveCheck"><span style="font-size: 14px;">–£–≤–µ–¥–æ–º–∏—Ç—å</span></label></div><button id="leaveGroupBtn" class="danger-btn" style="background: #ff9800;">–ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É</button></div></div></div>

    <div id="authModal" class="modal" style="display: none;">
        <div id="loginForm" class="glass-panel auth-container">
            <h2>–í—Ö–æ–¥</h2><input type="email" id="loginEmail" class="settings-input" placeholder="Email"><input type="password" id="loginPassword" class="settings-input" placeholder="–ü–∞—Ä–æ–ª—å"><div class="code-section"><button id="loginSendCodeBtn" class="secondary-btn">–ö–æ–¥</button><input type="text" id="loginCodeInput" class="settings-input" placeholder="–ö–æ–¥" style="width: 80px;"></div><div id="loginTimer" style="color:red; font-size:12px; height:15px;"></div><button id="loginBtn" class="primary-btn">–í–æ–π—Ç–∏</button><div class="divider">–∏–ª–∏</div><button id="googleLoginBtn" class="google-btn"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"> Google</button><p style="text-align:center; margin-top:10px;"><a href="#" id="toRegisterLink">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></p>
        </div>
        <div id="registerChoice" class="glass-panel auth-container" style="display: none;"><h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2><button id="googleRegBtn" class="google-btn"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"> Google</button><button id="toEmailRegBtn" class="primary-btn">Email</button><p style="text-align:center; margin-top:10px;"><a href="#" id="backToLoginFromChoice">–ù–∞–∑–∞–¥</a></p></div>
        <div id="registerEmailForm" class="glass-panel auth-container" style="display: none;"><h2>–ù–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</h2><input type="text" id="regUsername" class="settings-input" placeholder="@username"><input type="email" id="regEmail" class="settings-input" placeholder="Email"><input type="password" id="regPassword" class="settings-input" placeholder="–ü–∞—Ä–æ–ª—å"><input type="password" id="regPasswordConfirm" class="settings-input" placeholder="–ü–æ–≤—Ç–æ—Ä"><div class="code-section"><button id="regSendCodeBtn" class="secondary-btn">–ö–æ–¥</button><input type="text" id="regCodeInput" class="settings-input" placeholder="–ö–æ–¥" style="width: 80px;"></div><div id="regTimer" style="color:red; font-size:12px; height:15px;"></div><button id="regBtn" class="primary-btn">–°–æ–∑–¥–∞—Ç—å</button><p style="text-align:center; margin-top:10px;"><a href="#" id="backToChoice">–ù–∞–∑–∞–¥</a></p></div>
    </div>
    
    <div id="incomingCallModal" class="modal"><div class="glass-panel" style="text-align: center; width: 300px; padding: 30px;"><div class="incoming-avatar"><img id="incomingAvatarImg" src="https://cdn-icons-png.flaticon.com/512/847/847969.png"></div><h3 id="incomingCallerName">–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</h3><p style="color: var(--text-sub); margin-bottom: 25px;">–ì–æ–ª–æ—Å–æ–≤–æ–π –≤—ã–∑–æ–≤</p><div style="display: flex; gap: 30px; justify-content: center;"><button id="answerCallBtn" class="call-btn btn-answer"><span class="material-symbols-outlined">call</span></button><button id="rejectCallBtn" class="call-btn btn-hangup"><span class="material-symbols-outlined">call_end</span></button></div></div></div>

    <script type="module" src="./js/firebase-config.js"></script>
    <script type="module" src="./js/toast.js"></script>
    <script type="module" src="./js/auth.js"></script>
    <script type="module" src="./js/chat.js"></script>
    <script type="module" src="./js/call.js"></script>
</body>
</html>